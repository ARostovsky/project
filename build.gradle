apply plugin: 'groovy'

repositories {
    mavenCentral()
    maven {
        url "http://dl.bintray.com/jetbrains/teamcity-rest-client"
    }
}

dependencies {
    compile 'org.codehaus.groovy:groovy-all:2.4.8'
    compile 'org.apache.ant:ant:1.9.4'
    if (teamcity_rest_client_version == 'sources') {
        compile project('../teamcity-rest-client')
    } else {
        compile "org.jetbrains.teamcity:teamcity-rest-client:$teamcity_rest_client_version"
    }
}

task runScript (dependsOn: 'classes', type: JavaExec) {
    main = 'patchtest'
    classpath = sourceSets.main.runtimeClasspath

    def product = project.hasProperty('product') ? project.getProperty('product') : null
    def platform = project.hasProperty('platform') ? project.getProperty('platform') : null
    def buildConfigurationID = project.hasProperty('buildConfigurationID') ? project.getProperty('buildConfigurationID') : null
    def timeout = project.hasProperty('timeout') ? project.getProperty('timeout') : '60'
    def out = project.hasProperty('out') ? project.getProperty('out') : 'out'

    if (product && platform && buildConfigurationID){
        args sprintf("'product':'$product'," +
                     "'platform':'$platform'," +
                     "'buildConfigurationID':'$buildConfigurationID'," +
                     "'timeout':'$timeout'," +
                     "'out':'$out'")
    } else {
        throw new GradleException("Some args: {product, platform, buildConfigurationID} are undefined")
    }

}
